---
title: 'カスタムプロパティのフォールバックトリックを使ったTIPS'
summary: 'カスタムプロパティのフォールバックトリックを使った、知っているとちょっと便利かもしれないTIPSをご紹介します。'
publishedAt: '2025-03-15'
tags:
- css
- tips
draft: false
updatedAt: '2025-03-17'
---

## カスタムプロパティのフォールバックとは
参照したカスタムプロパティが宣言されていなかったり、
無効になってしまった時を考慮して設定することができる値のことです。
カスタムプロパティの初期値としても考えられます。

以下の例は、`--color`が無効だった場合は`green`が適用されます。

```css
.hoge {
  color: var(--color, green);
}
```

ご紹介するフォールバックトリックとは、
このフォールバックの仕組みを使ったハック的な実装のことになります。

### 便利だと思うところ
簡易的な`if`文のように使えるところです。
条件式はカスタムプロパティの組み合わせで表現します。

### 注意
**あまり浸透しているとは言えない実装になりますので、
多用は避けて効果が見込める箇所に限っての利用を強く推奨します。**

## 閑話休題
カスタムプロパティのより良い命名規則をご紹介します。
ローカルなカスタムプロパティは、`_`から始まるように宣言することでスコープの範囲が明確になります。
また、命名を短く凡庸的なものにすることで、より一層の差別化が可能になります。

```css
.hoge {
  --_color: green;

  color: var(--_color);
}
```

## 実装について
この記事では、フォールバックトリックが効果的に利用できる、`:hover`での実装をご紹介します。
他にもテーマ切り替えの実装で効果的に利用できそうですので、
こちらは後日に記事にしてみたいと思います。

### 方針
`:hover`でグローバルに利用したいため、`:root`要素にカスタムプロパティとして宣言します。
後に然るべきところで値をセットして上書きしていきます。

### カスタムプロパティの定義
最初にスタムプロパティの定義をします。実装の肝となる部分です。

```css
:root {
  --hover-on: ;
  --hover-off: initial;
}
```
[2.2. Guaranteed-Invalid Values](https://www.w3.org/TR/css-varｋables/#guaranteed-invalid)
によると、カスタムプロパティにおける空文字は有効な値であり、
`initial`を使うことで無効保証値と呼ばれる値にできるそうです。
カスタムプロパティの初期値はこの値になるそうです。

ドキュメントを翻訳した一部に、

>何らかの理由で、変数を手動で無効保証値にリセットしたい場合は、キーワードinitialを使用することで可能です。

と書かれています。

フォールバックトリックは、宣言の段階では`initial`で無効保証値としておき、オンデマンドで初期値を設定し、
フォールバックによって値を有効化させるロジックだと理解しています。

### `:hover`の実装
具体的な実装に入っていきます。
後にブラッシュアップを行いますが、全体としては以下のような実装になります。

冒頭で`if`分のように使えると書きましたので、
併せて条件式も書いていこうと思います。

```css
:root {
  --hover-on: ;
  --hover-off: initial;
}

:any-link {
  color: var(--hover-off, blue) var(--hover-on, green);

  &:hover {
    --hover-off: ;
    --hover-on: initial;
  }
}
```
通常時では、`--hover-on`が空文字であり、`--hover-off`が`initial`のため、
以下のように解釈されます。

<dl>
<dt>条件式</dt>
<dd>`--hover-on === '' && --hover-off === initial`</dd>
</dl>

```css
:any-link {
  --hover-on: ;
  --hover-off: initial;

  color: var(--hover-off, blue) ;
}
```

ホバー時では、`--hover-off`が空文字であり、`--hover-on`が`initial`のため、
以下のように解釈されます。

<dl>
<dt>条件式</dt>
<dd>`--hover-on === initial && --hover-off === ''`</dd>
</dl>

```css
:any-link :hover {
  --hover-on: initial;
  --hover-off: ;

  color:  var(--hover-on, green);
}
```
よく見てもらうと気づかれるかと思いますが、`var()`の前後に空白が含まれています。
この部分が空文字をセットしたカスタムプロパティの出力になります。

空白のためプロパティの値としては機能せず、フォールバックによって有効化された
カスタムプロパティの値が有効になります。

## ブラッシュアップ
コードのブラッシュアップを行います。
`@media (any-hover: hover)`を使用してポインターデバイスに`:hover`のスタイルを
適用し、タッチデバイスやキーボード操作に`:focus-visible`でスタイルを適用します。

ベースになるCSSに記述する内容となりますので、`:where`を使って詳細度を0に保ち、
後のCSSで上書きしやすくすると良いかと思います。

[Codepenのデモはこちら](https://codepen.io/73log/pen/KwKZyyg)

```css
:where(:root) {
  --hover-on: ;
  --hover-off: initial;
}

:where(:any-link) {
  --_color: var(--hover-on, green) var(--hover-off, blue);

  color: var(--_color);

  &:focus-visible {
    --hover-on: initial;
    --hover-off: ;
  }

  @media (any-hover: hover) {
    &:hover {
      --hover-on: initial;
      --hover-off: ;
    }
  }
}
```

## おわりに
知っていると便利に使える状況がある一方で、
浸透しているとは言えないハック的な実装なので多様は厳禁です。
以上になります。
